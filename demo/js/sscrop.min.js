/*! ng-sscrop 2015-05-13 */
function makeHighRes(a){var b=a.getContext("2d"),c=window.devicePixelRatio||1,d=b.webkitBackingStorePixelRatio||b.mozBackingStorePixelRatio||b.msBackingStorePixelRatio||b.oBackingStorePixelRatio||b.backingStorePixelRatio||1,e=c/d;if(c!==d){var f=a.width,g=a.height;a.width=Math.round(f*e),a.height=Math.round(g*e),a.style.width=f+"px",a.style.height=g+"px",b.scale(e,e)}}var module=angular.module("ng-sscrop",[]);module.directive("sscrop",function(){return{replace:"true",restrict:"E",scope:{src:"=",result:"=",w:"@",h:"@",crop:"=?",downscale:"@?",onLoad:"&?"},template:'<canvas style="cursor: pointer"></canvas>',link:function(a,b,c){function d(){if(a.src.width>0){n.fillStyle="#ff0ff0",n.fillRect(0,0,m.width,m.height);var b=a.result.zoom/100;n.drawImage(a.src,a.result.pos.x,a.result.pos.y,a.src.width*j*b,a.src.height*j*b)}}function e(b,c){if(a.src.width>0){var e=a.result.zoom/100,f=a.result.pos.x+b;f=Math.min(f,0),f=Math.max(f,o-a.src.width*j*e),f=Math.ceil(f);var g=a.result.pos.y+c;g=Math.min(g,0),g=Math.max(g,p-a.src.height*j*e),g=Math.ceil(g),a.result.pos.x=f,a.result.pos.y=g,d()}}function f(){if(a.src.width>0&&l){var b=q,c=b.getContext("2d"),d=a.result.zoom/100,e=1/j;c.drawImage(a.src,a.result.pos.x*e,a.result.pos.y*e,a.src.width*d,a.src.height*d);var f=b.toDataURL("image/jpeg");a.crop=f}}function g(a){t=a.layerX,u=a.layerY,s=!0}function h(b){s&&(t=-1,u=-1,s=!1,a.$apply(function(){f()}))}function i(b){s&&(a.$apply(function(){e(b.layerX-t,b.layerY-u)}),t=b.layerX,u=b.layerY)}var j=1,k=a.downscale/100;"downscale"in c&&k&&(j=k);var l="crop"in c;a.result.zoom=100,a.result.pos={x:0,y:0},a.result.crop="";var m=b[0],n=m.getContext("2d"),o=a.w*j,p=a.h*j;m.setAttribute("width",o),m.setAttribute("height",p),makeHighRes(m);var q=document.createElement("canvas");q.width=a.w,q.height=a.h;var r=10;a.src.onload=function(){r=Math.min(10*Math.ceil(10*Math.max(a.w/this.width,a.h/this.height)),100),a.$apply(function(){a.result.zoom=r,a.result.pos.x=0,a.result.pos.y=0,d()}),"onLoad"in c&&a.onLoad()},a.$watch("result.zoom",function(b,c){b!=c&&(r>b||b>100?a.result.zoom=Math.max(Math.min(r,100),r):(a.result.pos.x=0,a.result.pos.y=0,d(),f()))});var s=!1,t=-1,u=-1;b.bind("mousedown",g),b.bind("mouseout",h),b.bind("mouseup",h),b.bind("mousemove",i)}}});