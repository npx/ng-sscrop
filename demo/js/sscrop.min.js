/*! ng-sscrop 2015-05-21 */
function makeHighRes(a){var b=a.getContext("2d"),c=window.devicePixelRatio||1,d=b.webkitBackingStorePixelRatio||b.mozBackingStorePixelRatio||b.msBackingStorePixelRatio||b.oBackingStorePixelRatio||b.backingStorePixelRatio||1,e=c/d;if(c!==d){var f=a.width,g=a.height;a.width=Math.round(f*e),a.height=Math.round(g*e),a.style.width=f+"px",a.style.height=g+"px",b.scale(e,e)}}var module=angular.module("ng-sscrop",[]);module.directive("sscrop",function(){return{replace:"true",restrict:"E",scope:{src:"=",result:"=",w:"@",h:"@",crop:"=?",downscale:"@?",onLoad:"&?"},template:'<canvas style="cursor: pointer"></canvas>',link:function(a,b,c){function d(){if(a.src.width>0){p.fillStyle="#ff0ff0",p.fillRect(0,0,o.width,o.height);var b=a.result.zoom/100;p.drawImage(a.src,t.x,t.y,a.src.width*j*b,a.src.height*j*b)}}function e(b,c){if(a.src.width>0){var e=a.result.zoom/100,f=t.x+b;f=Math.min(f,0),f=Math.max(f,q-a.src.width*j*e),f=Math.ceil(f);var g=t.y+c;g=Math.min(g,0),g=Math.max(g,r-a.src.height*j*e),g=Math.ceil(g),t.x=f,t.y=g,a.result.pos.x=t.x*l*-1,a.result.pos.y=t.y*l*-1,d()}}function f(){if(a.src.width>0&&n){var b=s,c=b.getContext("2d"),d=a.result.zoom/100;c.drawImage(a.src,t.x*l,t.y*l,a.src.width*d,a.src.height*d);var e=b.toDataURL("image/jpeg");a.crop=e}}function g(a){w=a.layerX,x=a.layerY,v=!0}function h(b){v&&(w=-1,x=-1,v=!1,a.$apply(function(){f()}))}function i(b){v&&(a.$apply(function(){e(b.layerX-w,b.layerY-x)}),w=b.layerX,x=b.layerY)}var j=1,k=a.downscale/100,l=1,m=100/a.downscale;"downscale"in c&&k&&(j=k,l=m);var n="crop"in c;a.result.zoom=100,a.result.pos={x:0,y:0},a.result.size={w:a.w,h:a.h};var o=b[0],p=o.getContext("2d"),q=a.w*j,r=a.h*j;o.setAttribute("width",q),o.setAttribute("height",r),makeHighRes(o);var s=document.createElement("canvas");s.width=a.w,s.height=a.h;var t={x:0,y:0},u=10;a.src.onload=function(){u=Math.min(10*Math.ceil(10*Math.max(a.w/this.width,a.h/this.height)),100),a.$apply(function(){a.result.zoom=u,a.result.pos.x=0,a.result.pos.y=0,t.x=0,t.y=0,d()}),"onLoad"in c&&a.onLoad()},a.$watch("result.zoom",function(b,c){b!=c&&(u>b||b>100?a.result.zoom=Math.max(Math.min(u,100),u):(e(0,0),d(),f()))});var v=!1,w=-1,x=-1;b.bind("mousedown",g),b.bind("mouseout",h),b.bind("mouseup",h),b.bind("mousemove",i)}}});