/*! ng-sscrop 2015-05-12 */
function makeHighRes(a){var b=a.getContext("2d"),c=window.devicePixelRatio||1,d=b.webkitBackingStorePixelRatio||b.mozBackingStorePixelRatio||b.msBackingStorePixelRatio||b.oBackingStorePixelRatio||b.backingStorePixelRatio||1,e=c/d;if(c!==d){var f=a.width,g=a.height;a.width=Math.round(f*e),a.height=Math.round(g*e),a.style.width=f+"px",a.style.height=g+"px",b.scale(e,e)}}var module=angular.module("ng-sscrop",[]);module.directive("sscrop",function(){return{replace:"true",restrict:"E",scope:{src:"=",result:"=",w:"@",h:"@",downscale:"@?",onLoad:"&?"},template:'<canvas style="cursor: pointer"></canvas>',link:function(a,b,c){function d(){if(a.src.width>0){l.fillStyle="#ff0ff0",l.fillRect(0,0,k.width,k.height);var b=a.result.zoom/100;l.drawImage(a.src,a.result.pos.x,a.result.pos.y,a.src.width*j*b,a.src.height*j*b)}}function e(b,c){if(a.src.width>0){var e=a.result.zoom/100,f=a.result.pos.x+b;f=Math.min(f,0),f=Math.max(f,m-a.src.width*j*e),f=Math.ceil(f);var g=a.result.pos.y+c;g=Math.min(g,0),g=Math.max(g,n-a.src.height*j*e),g=Math.ceil(g),a.result.pos.x=f,a.result.pos.y=g,d()}}function f(){if(a.src.width>0){var b=o,c=b.getContext("2d"),d=a.result.zoom/100,e=1/j;c.drawImage(a.src,a.result.pos.x*e,a.result.pos.y*e,a.src.width*d,a.src.height*d);var f=b.toDataURL("image/jpeg");a.result.crop=f}}function g(a){r=a.layerX,s=a.layerY,q=!0}function h(b){q&&(r=-1,s=-1,q=!1,a.$apply(function(){f()}))}function i(b){q&&(a.$apply(function(){e(b.layerX-r,b.layerY-s)}),r=b.layerX,s=b.layerY)}var j=a.downscale/100?a.downscale/100:1;a.result.zoom=100,a.result.pos={x:0,y:0},a.result.crop="";var k=b[0],l=k.getContext("2d"),m=a.w*j,n=a.h*j;k.setAttribute("width",m),k.setAttribute("height",n),makeHighRes(k);var o=document.createElement("canvas");o.width=a.w,o.height=a.h;var p=10;a.src.onload=function(){p=Math.min(10*Math.ceil(10*Math.max(a.w/this.width,a.h/this.height)),100),a.$apply(function(){a.result.zoom=p,a.result.pos.x=0,a.result.pos.y=0,d()}),a.onLoad&&a.onLoad()},a.$watch("result.zoom",function(b,c){b!=c&&(p>b||b>100?a.result.zoom=Math.max(Math.min(p,100),p):(a.result.pos.x=0,a.result.pos.y=0,d(),f()))});var q=!1,r=-1,s=-1;b.bind("mousedown",g),b.bind("mouseout",h),b.bind("mouseup",h),b.bind("mousemove",i)}}});